
library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(zoo)
library(readxl)

library(msprog)

# source('/Users/nmontobbio/code/MSprogression/R-MSprog/msprog/R/MSprog.R')
# source('/Users/nmontobbio/code/MSprogression/R-MSprog/msprog/R/utils.R')

#####################################################################################
# Settings

# Data
value_col <- 'CLINICAL_EDSS_Score_Observed'
date_col <- 'VISIT_Date'
rdate_col <- 'VISIT_Date'
subj_col <- 'SUBJECT_Trial_ID_Number'
rsubj_col <- 'SUBJECT_Trial_ID_Number'
subjects <- NULL # (optional) subset of subjects (if NULL, compute on all subjects)

# Progression settings
outcome <- 'edss' # 'edss','nhptD','nhptND','t25fw','sdmt'
conf_months <- c(3, 6) # period before confirmation (months)
conf_tol_days <- 45 # tolerance window for confirmation visit (days): [t(months)-conf_tol(days), t(months)+conf_tol(days)]
conf_left <- FALSE # if TRUE, confirmation window is [t(months)-conf_tol(days), inf)
require_sust_months <- 0 # count an event as such only if sustained for _ months from confirmation
rel_infl <- 90 # influence of last relapse (days)
event <- 'multiple'   # 'first' [only the very first event - improvement or progression]
                      # 'firsteach' [first improvement and first progression]
                      # 'firstprog' [first progression]
                      # 'firstprogtype' [first progression of each kind - PIRA, RAW, undefined]
                      # 'multiple' [all events - to use coupled with roving baseline!]
baseline <- 'roving' # 'fixed', 'roving'
sub_threshold <- FALSE # if TRUE, include confirmed sub-threshold events for roving baseline
relapse_rebl <- FALSE # if TRUE, search for PIRA events again with post-relapse re-baseline
min_value <- 0 # only consider as progressions those events where the outcome is >= min_value
prog_last_visit <- FALSE # if TRUE, include progressions occurring at last visit (i.e. with no confirmation!)
verbose <- 2 # 0[print no info], 1[print concise info], 2[print extended info]
include_dates <- TRUE # if TRUE, include baseline and event dates
include_value <- TRUE # if TRUE, include outcome value at baseline and at event

# Custom delta function
delta_fun <- NULL
# delta_fun <- function(baseline) {
#   return(min(baseline/40, 4))
# }

#####################################################################################
# SETUP

# Load data
data <- read_excel("/Users/nmontobbio/code/DATA/MSprog-oratorio/oratorio_edss.xlsx")
relapse <- read_excel("/Users/nmontobbio/code/DATA/MSprog-oratorio/oratorio_relapse.xlsx")


# Remove missing values
data <- na.omit(data)
relapse <- na.omit(relapse)


#####################################################################################
# Compute progression

output <- MSprog(data, subj_col, value_col, date_col, subjects=subjects, relapse=relapse, rdate_col=rdate_col, rsubj_col=rsubj_col,
                  outcome=outcome, delta_fun=delta_fun, conf_months=conf_months, conf_tol=conf_tol, conf_left=conf_left,
                  require_sust_months=require_sust_months, rel_infl=rel_infl, event=event, baseline=baseline,
                  sub_threshold=sub_threshold, relapse_rebl=relapse_rebl, min_value=min_value,
                  prog_last_visit=prog_last_visit, verbose=verbose, include_dates=include_dates,
                  include_value=include_value)

summary = output[[1]] # summary of detected events for each subject
results = output[[2]] # extended info on event sequence for each subject

