sust_idx <- ifelse(is.na(next_nonsust), nvisits, next_nonsust - 1)
event_type <- c(event_type, "impr")
event_index <- c(event_index, change_idx)
bldate <- c(bldate, as.character(global_start + as.difftime(bl[[date_col]], units='days')))
blvalue <- c(blvalue, bl[[value_col]])
edate <- c(edate, as.character(global_start + as.difftime(data_id[change_idx,][[date_col]], units='days')))
evalue <- c(evalue, data_id[change_idx,][[value_col]])
time2event <- c(time2event, data_id[change_idx,][[date_col]] - bl[[date_col]])
for (m in conf_months) {
conf[[as.character(m)]] <- c(conf[[as.character(m)]], as.integer(m %in% conf_t))
if (m!=conf_months[1]) {pira_conf[[as.character(m)]] <- c(pira_conf[[as.character(m)]], NA)}
}
sustd <- c(sustd, data_id[sust_idx,][[date_col]] - data_id[conf_idx[[length(conf_idx)]],][[date_col]])
sustl <- c(sustl, as.integer(sust_idx == nvisits))
if (baseline == "roving") {
bl_idx <- ifelse(is.na(next_change), nvisits, next_change - 1)
search_idx <- bl_idx + 1
} else {
search_idx <- ifelse(is.na(next_change), nvisits, next_change)
}
if (verbose == 2) {
message(toupper(outcome), " improvement (visit no.", change_idx, ", ",
global_start + as.difftime(data_id[change_idx,][[date_col]], units='days'),
") confirmed at ", paste(conf_t, collapse = ", "), " months, sustained up to visit no.", sust_idx,
" (",
global_start + as.difftime(data_id[sust_idx,][[date_col]], units='days'), ")")
message("New settings: baseline at visit no.", bl_idx, ", searching for events from visit no.",
ifelse(search_idx > nvisits, "-", search_idx), " on")
}
} else {
search_idx <- change_idx + 1
if (verbose == 2) {
message("Change confirmed but not sustained for >=", require_sust_months,
" months: proceed with search")
}
}
}
# Confirmed sub-threshold improvement: RE-BASELINE
# ------------------------------------------------
else if (length(conf_idx) > 0 && # confirmation visits available
data_id[change_idx, value_col] < bl[value_col] && # value decreased from baseline
data_id[conf_idx[[1]], value_col] < bl[value_col] && # decrease is confirmed
baseline == 'roving' && sub_threshold &&
phase == 0) { # skip if re-checking for PIRA after post-relapse re-baseline
if (conf_idx[[1]]==nvisits) {
next_change <- NA} else {
next_change <- which(data_id[(conf_idx[[1]] + 1):nvisits, value_col]
> bl[[value_col]])[1] + conf_idx[[1]] }
bl_idx <- ifelse(is.na(next_change), nvisits, next_change - 1) # set new baseline at last consecutive decreased value
search_idx <- next_change
if (verbose == 2) {
message("Confirmed sub-threshold ", toupper(outcome), " improvement (visit no.", change_idx, ")")
message("New settings: baseline at visit no.", bl_idx, ", searching for events from visit no.",
ifelse(is.na(search_idx), "-", search_idx), " on")
}
}
# CONFIRMED PROGRESSION:
# ---------------------
else if (data_id[change_idx, value_col] >= min_value &&
data_id[change_idx, value_col] - bl[value_col] >= delta(bl[value_col]) && # value increased (>delta) from baseline
((length(conf_idx) > 0 && # confirmation visits available
all(sapply((change_idx + 1):conf_idx[[1]],
function(x) data_id[x, value_col] - bl[value_col] >= delta(bl[value_col]))) && # increase is confirmed at first valid date
all(sapply((change_idx + 1):conf_idx[[1]],
function(x) data_id[x, value_col] >= min_value)) # confirmation above min_value too
) || (prog_last_visit && change_idx == nvisits))
) {
if (change_idx == nvisits) {
conf_idx <- c(nvisits)
}
if (conf_idx[[1]]==nvisits) {
next_change <- NA} else {
next_change <- which(data_id[(conf_idx[[1]] + 1):nvisits, value_col] - bl[[value_col]]
< delta(bl[[value_col]]))[1] + conf_idx[[1]] }
if (!is.na(next_change)) {
conf_idx <- conf_idx[conf_idx < next_change] } # confirmed dates
conf_t <- conf_t[seq_along(conf_idx)]
# sustained until:
next_change <- NA
if (conf_idx[[length(conf_idx)]]<nvisits) {
for (x in (conf_idx[[length(conf_idx)]] + 1):nvisits) {
if (data_id[x,][[value_col]] - bl[[value_col]] < delta(bl[[value_col]]) ||
abs(data_id[x,][[value_col]] - data_id[conf_idx[[length(conf_idx)]],][[value_col]])
>= delta(data_id[conf_idx[[length(conf_idx)]],][[value_col]])) {
next_change <- x
break
}
}
next_nonsust <- which(data_id[(conf_idx[[length(conf_idx)]] + 1):nvisits, value_col]
- bl[[value_col]] < delta(bl[[value_col]]))[1] + conf_idx[[length(conf_idx)]]
} else {next_nonsust <- NA}
valid_prog <- 1
if (require_sust_months) {
valid_prog <- is.na(next_nonsust) || (data_id[next_nonsust,][[date_col]] -
data_id[conf_idx[[length(conf_idx)]],][[date_col]]) > require_sust_months * 30.44
}
if (valid_prog) {
sust_idx <- ifelse(is.na(next_nonsust), nvisits, next_nonsust - 1)
if (phase == 0 && data_id[change_idx, 'closest_rel_minus'] <= rel_infl) { # event occurs within relapse influence
event_type <- c(event_type, 'RAW')
event_index <- c(event_index, change_idx)
} else if (data_id[change_idx, 'closest_rel_minus'] > rel_infl) { # event occurs out of relapse influence
# rel_inbetween <- sapply(conf_idx,
#           function(ic) any(is_rel[date_dict[[as.character(bl_idx)]]:date_dict[[as.character(ic)]]]))
if (pira_def==0) {
rel_inbetween <- sapply(conf_idx,
function(ic) ifelse(length(relapse_dates)>0,
any((data_id[bl_idx,][[date_col]]<=relapse_dates)
& (relapse_dates<=data_id[ic,][[date_col]])), FALSE))
} else if (pira_def==1) {
rel_inbetween <- sapply(conf_idx,
function(ic) ifelse(length(relapse_dates)>0, any(
((data_id[bl_idx,][[date_col]]<=relapse_dates) & (relapse_dates<=data_id[change_idx,][[date_col]]+rel_infl))
| ((data_id[ic,][[date_col]]-rel_infl<=relapse_dates) & (relapse_dates<=data_id[ic,][[date_col]]+rel_infl))),
FALSE))
}
if (any(rel_inbetween)) {
if (min(which(rel_inbetween))>1) {
pconf_idx <- conf_idx[1:(min(which(rel_inbetween)) - 1)] } else {pconf_idx = list()}
} else {pconf_idx = conf_idx}
if (length(pconf_idx) > 0
&& data_id[pconf_idx[[length(pconf_idx)]], 'closest_rel_plus'] <= rel_infl) {
pconf_idx <- pconf_idx[-length(pconf_idx)]
}
pconf_t <- conf_t[seq_along(pconf_idx)]
if (length(pconf_idx) > 0) {
for (m in conf_months) {
if (m!=conf_months[1]) {
pira_conf[[as.character(m)]] <- c(pira_conf[[as.character(m)]], as.integer(m %in% pconf_t))}
}
event_type <- c(event_type, 'PIRA')
event_index <- c(event_index, change_idx)
} else if (phase == 0) {
event_type <- c(event_type, 'prog')
event_index <- c(event_index, change_idx)
}
}
if (phase==0 & event_type[length(event_type)] != 'PIRA') {
for (m in conf_months) {
if (m!=conf_months[1]) {pira_conf[[as.character(m)]] <- c(pira_conf[[as.character(m)]], NA)}
}
}
if (event_type[length(event_type)] == 'PIRA' || phase == 0) {
bldate <- c(bldate, as.character(global_start + as.difftime(bl[[date_col]], units='days')))
blvalue <- c(blvalue, bl[[value_col]])
edate <- c(edate, as.character(global_start + as.difftime(data_id[change_idx,][[date_col]], units='days')))
evalue <- c(evalue, data_id[change_idx,][[value_col]])
time2event <- c(time2event, data_id[change_idx,][[date_col]] - bl[[date_col]])
for (m in conf_months) {
conf[[as.character(m)]] <- c(conf[[as.character(m)]], as.integer(m %in% conf_t))
}
sustd <- c(sustd, data_id[sust_idx,][[date_col]]
- data_id[conf_idx[[length(conf_idx)]],][[date_col]])
sustl <- c(sustl, as.integer(sust_idx == nvisits))
if (verbose == 2) {
message(toupper(outcome), " progression[", event_type[length(event_type)],
"] (visit no.", change_idx, ", ",
global_start + as.difftime(data_id[change_idx,][[date_col]], units='days'),
") confirmed at ", paste(conf_t, collapse = ", "), " months, sustained up to visit no.", sust_idx,
" (", global_start + as.difftime(data_id[sust_idx,][[date_col]], units='days'), ")")
}
}
if ((baseline == 'roving' && phase == 0) # || (event_type[length(event_type)] == 'PIRA' && phase == 1)
) {
bl_idx <- ifelse(is.na(next_change), nvisits, next_change - 1) # set new baseline at last confirmation time
search_idx <- bl_idx + 1
} else {
search_idx <- ifelse(is.na(next_change), nvisits, next_change) # next_nonsust
}
if (verbose == 2 && phase == 0) {
message("New settings: baseline at visit no.", bl_idx, ", searching for events from visit no.",
ifelse(search_idx > nvisits, "-", search_idx), " on")
}
} else {
search_idx <- change_idx + 1 # skip the change and look for other patterns after it
if (verbose == 2) {
message("Change confirmed but not sustained for >=", require_sust_months,
" months: proceed with search")
}
}
}
# Confirmed sub-threshold progression: RE-BASELINE
# ------------------------------------------------
else if (length(conf_idx) > 0 && data_id[change_idx, value_col] > bl[[value_col]]
&& data_id[conf_idx[[1]], value_col] > bl[[value_col]] && baseline == "roving"
&& sub_threshold && phase == 0) {
if (conf_idx[[1]]==nvisits) {
next_change <- NA} else {
next_change <- which(data_id[(conf_idx[[1]] + 1):nvisits, value_col]
< bl[[value_col]])[1] + conf_idx[[1]] }
bl_idx <- ifelse(is.na(next_change), nvisits, next_change - 1)
search_idx <- bl_idx + 1
if (verbose == 2) {
message("Confirmed sub-threshold", toupper(outcome), "progression (visit no.", change_idx, ")")
message("New settings: baseline at visit no.", bl_idx,
", searching for events from visit no.", search_idx, " on")
}
}
# NO confirmation:
# ----------------
else {
search_idx <- change_idx + 1
if (verbose == 2) {
message("Change not confirmed: proceed with search")
}
}
}
if (relapse_rebl && phase == 0 && !proceed) { # && !("PIRA" %in% event_type)
phase <- 1
proceed <- 1
bl_idx <- 1
search_idx <- 2 #bl_idx + 1 #
if (verbose == 2) {
message("Completed search with fixed baseline, re-search for PIRA events with post-relapse rebaseline")
}
}
if (proceed && ((event == "first" && length(event_type) > 1) ||
(event == "firsteach" && ("impr" %in% event_type) && ("prog" %in% event_type)) ||
(event == "firstprog" && (("RAW" %in% event_type) || ("PIRA" %in% event_type) || ("prog" %in% event_type))) ||
(event == "firstprogtype" && ("RAW" %in% event_type) && ("PIRA" %in% event_type) && ("prog" %in% event_type)))) {
proceed <- 0
if (verbose == 2) {
message("First events already found: end process")
}
}
if (proceed && search_idx <= nvisits &&
any(is_rel[date_dict[[as.character(bl_idx)]]:date_dict[[as.character(search_idx)]]]) # if search_idx has been moved after another relapse
&& relapse_rebl && phase == 1) {
if (bl_idx < nvisits) {
bl_idx <- sapply(bl_idx, function (ib) {
out <- NA
for (x in (ib + 1):nvisits) { # visits after current baseline (or after last confirmed PIRA)
if (any(is_rel[date_dict[[as.character(ib)]]:date_dict[[as.character(x)]]]) # after a relapse
& (data_id[x, 'closest_rel_minus'] > rel_infl) # out of relapse influence
){
out <- x
break
}
}
out
})
} else {bl_idx <- NA}
if (!is.na(bl_idx)) {
search_idx <- bl_idx + 1
if (verbose == 2) {
message("New settings: baseline at visit no.", bl_idx,
", searching for events from visit no.", search_idx, " on")
}
}
if (proceed && (is.na(bl_idx) || bl_idx > nvisits - 1)) {
proceed <- 0
if (verbose == 2) {
message("Not enough visits after current baseline: end process")
}
}
}
} #while (proceed)
subj_index <- as.numeric(row.names(results[results[subj_col] == subjid, ]))
if (length(event_type) > 1) {
event_type <- event_type[2:length(event_type)]  # remove first empty event
# Spot duplicate events
# (can only occur if relapse_rebl is enabled - in that case, only keep last detected)
uevents <- unique(event_index)
ucounts <- table(event_index)
duplicates <- uevents[ucounts > 1]
diff <- length(event_index) - length(uevents) # keep track of no. duplicates
for (ev in duplicates) {
all_ind <- which(event_index == ev)
event_index[all_ind[-length(all_ind)]] <- 0 # mark duplicate events with 0
}
event_order <- order(event_index)
event_order <- event_order[(diff+1):length(event_order)] # eliminate duplicates (those marked with 0)
event_type <- event_type[event_order]
if (startsWith(event, "first")) {
impr_idx <- which(event_type == "impr")[1]
prog_idx <- which(event_type %in% c("prog", "RAW", "PIRA"))[1]
raw_idx <- which(event_type == "RAW")[1]
pira_idx <- which(event_type == "PIRA")[1]
undef_prog_idx <- which(event_type == "prog")[1]
if (event == "firsteach") {
first_events <- c(impr_idx, prog_idx)
} else if (event == "firstprog") {
first_events <- c(prog_idx)
} else if (event == "firstprogtype") {
first_events <- c(raw_idx, pira_idx, undef_prog_idx)
}
if (event=='first') {first_events <- 1} else {first_events <- unique(na.omit(first_events))}
event_type <- event_type[first_events]
event_order <- event_order[first_events]
}
if (max_nevents>1) {
results <- results[-subj_index[(length(event_type) + 1):length(subj_index)], ]
rownames(results) <- NULL # reset column names
}
results[results[[subj_col]] == subjid, "event_type"] <- event_type
results[results[[subj_col]] == subjid, "bldate"] <- bldate[event_order]
results[results[[subj_col]] == subjid, "blvalue"] <- blvalue[event_order]
results[results[[subj_col]] == subjid, "date"] <- edate[event_order]
results[results[[subj_col]] == subjid, "value"] <- evalue[event_order]
results[results[[subj_col]] == subjid, "time2event"] <- time2event[event_order]
for (m in conf_months) {
results[results[[subj_col]] == subjid, paste0("conf", m)] <- conf[[as.character(m)]][event_order]
}
results[results[[subj_col]] == subjid, "sust_days"] <- sustd[event_order]
results[results[[subj_col]] == subjid, "sust_last"] <- sustl[event_order]
for (m in conf_months) {
if (m!=conf_months[1]) {
results[results[[subj_col]] == subjid, paste0("PIRA_conf", m)] <- pira_conf[[as.character(m)]][event_order]}
}
} else if (include_stable) {
if (max_nevents>1) {
results <- results[-subj_index[2:length(subj_index)], ]
rownames(results) <- NULL # reset column names
}
results[results[[subj_col]]==subjid, 'nevent'] = 0
results[results[[subj_col]]==subjid, 'time2event'] = total_fu[subjid]
results[results[[subj_col]]==subjid, 'event_type'] = ''
} else {
results <- results[-subj_index, ]
rownames(results) <- NULL # reset column names
}
improvement <- sum(results[results[[subj_col]] == subjid, "event_type"] == "impr")
progression <- sum(results[results[[subj_col]] == subjid, "event_type"] %in% c("prog", "RAW", "PIRA"))
undefined_prog <- sum(results[results[[subj_col]] == subjid, "event_type"] == "prog")
RAW <- sum(results[results[[subj_col]] == subjid, "event_type"] == "RAW")
PIRA <- sum(results[results[[subj_col]] == subjid, "event_type"] == "PIRA")
summary[as.character(subjid), c('improvement', 'progression', 'RAW', 'PIRA', 'undefined_prog'
)] <- c(improvement, progression, RAW, PIRA, undefined_prog)
summary[as.character(subjid), 'event_sequence'] <- paste(event_type, collapse = ", ")
if (startsWith(event, "firstprog")) {
summary <- summary[, !colnames(summary) %in% "improvement"]
}
if (verbose == 2) {
message("Event sequence: ", ifelse(length(event_type) > 0,
paste(event_type, collapse = ", "), "-"), sep = "")
}
roxygen2::roxygenise()
rm(list = c("MSprog"))
roxygen2::roxygenise()
roxygen2::roxygenise()
library(msprog)
library(readxl)
library(msprog)
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/MSprog.R')
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/utils.R')
#####################################################################################
# Settings
# Data
value_col <- 'CLINICAL_EDSS_Score_Observed'
date_col <- 'VISIT_Date'
rdate_col <- 'VISIT_Date'
subj_col <- 'RID'
rsubj_col <- 'RID'
subjects <- NULL # (optional) subset of subjects (if NULL, compute on all subjects)
# Progression settings
outcome <- 'edss' # 'edss','nhptD','nhptND','t25fw','sdmt'
conf_months <- c(3, 6) # period before confirmation (months)
conf_tol_days <- 45 # tolerance window for confirmation visit (days): [t(months)-conf_tol(days), t(months)+conf_tol(days)]
conf_left <- FALSE # if TRUE, confirmation window is [t(months)-conf_tol(days), inf)
require_sust_months <- 0 # count an event as such only if sustained for _ months from confirmation
rel_infl <- 90 # influence of last relapse (days)
event <- 'multiple'   # 'first' [only the very first event - improvement or progression]
# 'firsteach' [first improvement and first progression]
# 'firstprog' [first progression]
# 'firstprogtype' [first progression of each kind - PIRA, RAW, undefined]
# 'multiple' [all events - to use coupled with roving baseline!]
baseline <- 'roving' # 'fixed', 'roving'
pira_def <- 0   # 0 (no relapses in reference->confirmation)
# 1 (no relapses in reference->progression+rel_infl, and in confirmation-rel_infl->confirmation+rel_infl)
sub_threshold <- FALSE # if TRUE, include confirmed sub-threshold events for roving baseline
relapse_rebl <- FALSE # if TRUE, search for PIRA events again with post-relapse re-baseline
min_value <- 0 # only consider as progressions those events where the outcome is >= min_value
prog_last_visit <- FALSE # if TRUE, include progressions occurring at last visit (i.e. with no confirmation!)
verbose <- 2 # 0[print no info], 1[print concise info], 2[print extended info]
include_dates <- TRUE # if TRUE, include baseline and event dates
include_value <- TRUE # if TRUE, include outcome value at baseline and at event
include_stable <- TRUE # if TRUE, include subjects with no events in `results`.
delta_fun <- NULL # custom delta function
#####################################################################################
# SETUP
# Load data
data <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/subgroup_noemi.xlsx")
relapse <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/relapse_noemi.xlsx")
# Remove missing values
data <- data[complete.cases(data[ , c(subj_col, value_col, date_col)]), ]
relapse <- relapse[complete.cases(relapse[ , c(rsubj_col, rdate_col)]), ]
#####################################################################################
# Compute progression
output <- MSprog(data, subj_col, value_col, date_col, subjects=subjects, relapse=relapse, rdate_col=rdate_col, rsubj_col=rsubj_col,
outcome=outcome, delta_fun=delta_fun, conf_months=conf_months, conf_tol_days=conf_tol_days, conf_left=conf_left,
require_sust_months=require_sust_months, rel_infl=rel_infl, event=event, baseline=baseline, pira_def=pira_def,
sub_threshold=sub_threshold, relapse_rebl=relapse_rebl, min_value=min_value,
prog_last_visit=prog_last_visit, verbose=verbose, include_dates=include_dates,
include_value=include_value, include_stable=include_stable)
summary = output[[1]] # summary of detected events for each subject
results = output[[2]] # extended info on event sequence for each subject
#####################################################################################
View(results)
library(readxl)
library(msprog)
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/MSprog.R')
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/utils.R')
#####################################################################################
# Settings
# Data
value_col <- 'CLINICAL_EDSS_Score_Observed'
date_col <- 'VISIT_Date'
rdate_col <- 'VISIT_Date'
subj_col <- 'RID'
rsubj_col <- 'RID'
subjects <- NULL # (optional) subset of subjects (if NULL, compute on all subjects)
# Progression settings
outcome <- 'edss' # 'edss','nhptD','nhptND','t25fw','sdmt'
conf_left <- FALSE # if TRUE, confirmation window is [t(months)-conf_tol(days), inf)
require_sust_months <- 0 # count an event as such only if sustained for _ months from confirmation
event <- 'first'   # 'first' [only the very first event - improvement or progression]
# 'firsteach' [first improvement and first progression]
# 'firstprog' [first progression]
# 'firstprogtype' [first progression of each kind - PIRA, RAW, undefined]
# 'multiple' [all events - to use coupled with roving baseline!]
baseline <- 'fixed' # 'fixed', 'roving'
sub_threshold <- FALSE # if TRUE, include confirmed sub-threshold events for roving baseline
relapse_rebl <- FALSE # if TRUE, search for PIRA events again with post-relapse re-baseline
min_value <- 0 # only consider as progressions those events where the outcome is >= min_value
verbose <- 2 # 0[print no info], 1[print concise info], 2[print extended info]
include_dates <- TRUE # if TRUE, include baseline and event dates
include_value <- TRUE # if TRUE, include outcome value at baseline and at event
include_stable <- TRUE # if TRUE, include subjects with no events in `results`.
delta_fun <- NULL # custom delta function
#####################################################################################
# SETUP
# Load data
data <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/subgroup_noemi.xlsx")
relapse <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/relapse_noemi.xlsx")
# Remove missing values
data <- data[complete.cases(data[ , c(subj_col, value_col, date_col)]), ]
relapse <- relapse[complete.cases(relapse[ , c(rsubj_col, rdate_col)]), ]
#####################################################################################
# Compute progression
# Parameters to vary:
conf_months <- c(3, 6) # period before confirmation (months)
conf_tol_days <- 30 # tolerance window for confirmation visit (days): [t(months)-conf_tol(days), t(months)+conf_tol(days)]
rel_infl <- 30 # influence of last relapse (days)
prog_last_visit <- FALSE # if TRUE, include progressions occurring at last visit (i.e. with no confirmation!)
pira_def <- 0   # 0 (no relapses in reference->confirmation)
# 1 (no relapses in reference->progression+rel_infl, and in confirmation-rel_infl->confirmation+rel_infl)
output <- MSprog(data, subj_col, value_col, date_col, subjects=subjects, relapse=relapse, rdate_col=rdate_col, rsubj_col=rsubj_col,
outcome=outcome, delta_fun=delta_fun, conf_months=conf_months, conf_tol_days=conf_tol_days, conf_left=conf_left,
require_sust_months=require_sust_months, rel_infl=rel_infl, event=event, baseline=baseline, pira_def=pira_def,
sub_threshold=sub_threshold, relapse_rebl=relapse_rebl, min_value=min_value,
prog_last_visit=prog_last_visit, verbose=verbose, include_dates=include_dates,
include_value=include_value, include_stable=include_stable)
summary = output[[1]] # summary of detected events for each subject
results = output[[2]] # extended info on event sequence for each subject
#####################################################################################
library(readxl)
library(msprog)
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/MSprog.R')
# source('/Users/nmontobbio/code/MSprog/R-MSprog/msprog/R/utils.R')
#####################################################################################
# Settings
# Data
value_col <- 'CLINICAL_EDSS_Score_Observed'
date_col <- 'VISIT_Date'
rdate_col <- 'VISIT_Date'
subj_col <- 'RID'
rsubj_col <- 'RID'
subjects <- NULL # (optional) subset of subjects (if NULL, compute on all subjects)
# Progression settings
outcome <- 'edss' # 'edss','nhptD','nhptND','t25fw','sdmt'
conf_left <- FALSE # if TRUE, confirmation window is [t(months)-conf_tol(days), inf)
require_sust_months <- 0 # count an event as such only if sustained for _ months from confirmation
event <- 'firstprogtype'   # 'first' [only the very first event - improvement or progression]
# 'firsteach' [first improvement and first progression]
# 'firstprog' [first progression]
# 'firstprogtype' [first progression of each kind - PIRA, RAW, undefined]
# 'multiple' [all events - to use coupled with roving baseline!]
baseline <- 'fixed' # 'fixed', 'roving'
sub_threshold <- FALSE # if TRUE, include confirmed sub-threshold events for roving baseline
relapse_rebl <- FALSE # if TRUE, search for PIRA events again with post-relapse re-baseline
min_value <- 0 # only consider as progressions those events where the outcome is >= min_value
verbose <- 2 # 0[print no info], 1[print concise info], 2[print extended info]
include_dates <- TRUE # if TRUE, include baseline and event dates
include_value <- TRUE # if TRUE, include outcome value at baseline and at event
include_stable <- TRUE # if TRUE, include subjects with no events in `results`.
delta_fun <- NULL # custom delta function
#####################################################################################
# SETUP
# Load data
data <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/subgroup_noemi.xlsx")
relapse <- read_excel("/Users/nmontobbio/Library/CloudStorage/OneDrive-unige.it/DATA/MSprog-francesca4/relapse_noemi.xlsx")
# Remove missing values
data <- data[complete.cases(data[ , c(subj_col, value_col, date_col)]), ]
relapse <- relapse[complete.cases(relapse[ , c(rsubj_col, rdate_col)]), ]
#####################################################################################
# Compute progression
# Parameters to vary:
conf_months <- c(3, 6) # period before confirmation (months)
conf_tol_days <- 30 # tolerance window for confirmation visit (days): [t(months)-conf_tol(days), t(months)+conf_tol(days)]
rel_infl <- 30 # influence of last relapse (days)
prog_last_visit <- FALSE # if TRUE, include progressions occurring at last visit (i.e. with no confirmation!)
pira_def <- 0   # 0 (no relapses in reference->confirmation)
# 1 (no relapses in reference->progression+rel_infl, and in confirmation-rel_infl->confirmation+rel_infl)
output <- MSprog(data, subj_col, value_col, date_col, subjects=subjects, relapse=relapse, rdate_col=rdate_col, rsubj_col=rsubj_col,
outcome=outcome, delta_fun=delta_fun, conf_months=conf_months, conf_tol_days=conf_tol_days, conf_left=conf_left,
require_sust_months=require_sust_months, rel_infl=rel_infl, event=event, baseline=baseline, pira_def=pira_def,
sub_threshold=sub_threshold, relapse_rebl=relapse_rebl, min_value=min_value,
prog_last_visit=prog_last_visit, verbose=verbose, include_dates=include_dates,
include_value=include_value, include_stable=include_stable)
summary = output[[1]] # summary of detected events for each subject
results = output[[2]] # extended info on event sequence for each subject
#####################################################################################
